<!-- 无障碍支持：屏幕阅读器状态通知区域 -->
<view aria-live="polite" aria-atomic="true" class="sr-only">
  <block wx:if="{{loading}}">正在生成祝福语，请稍候...</block>
  <block wx:elif="{{error}}">错误：{{error}}</block>
  <block wx:elif="{{copySuccess}}">祝福语已成功复制到剪贴板</block>
  <block wx:elif="{{blessing && !loading && !error}}">祝福语生成完成</block>
</view>

<!-- 主内容区域：三段式布局 -->
<view class="container">
  <view class="form-section card-primary {{formError ? 'form-error' : ''}}">
    <!-- 装饰元素 -->
    <view class="decoration-tr"></view>

    <!-- 模式选择 -->
    <view class="mode-selector text-center mb-6">
      <view class="title festive-title">
        <text decode="{{true}}">🎊 祝福语生成器</text>
      </view>

      <view class="mode-buttons">
        <button
          class="btn-mode {{!formData.useSmartMode ? 'btn-mode-active btn-template-active' : 'btn-mode-inactive'}}"
          bindtap="toggleMode"
          data-mode="template"
        >
          📝 选择模板
        </button>
        <button
          class="btn-mode {{formData.useSmartMode ? 'btn-mode-active btn-smart-active' : 'btn-mode-inactive'}}"
          bindtap="toggleMode"
          data-mode="smart"
        >
          🎤 语音输入
        </button>
      </view>
    </view>

    <form bindsubmit="onSubmit" class="form-content">
      <!-- 智能模式表单 -->
      <view wx:if="{{formData.useSmartMode}}" class="mode-content">
        <view class="input-group">
          <label class="input-label">请描述您的祝福需求</label>
          <view class="voice-input-container">
            <textarea
              class="textarea-input"
              placeholder="例如：明天是我最好的朋友小明的生日，他最近工作很辛苦，想给他一个温暖的生日祝福..."
              value="{{formData.customDescription}}"
              bindinput="onInputChange"
              data-field="customDescription"
              maxlength="300"
            ></textarea>
            <button class="voice-btn" bindtap="onVoiceInput">
              <text>🎤 语音输入</text>
            </button>
          </view>
          <view class="char-count">{{formData.customDescription.length}}/300</view>
        </view>
      </view>

      <!-- 经典模板模式表单 - 逐步引导模式 -->
      <view wx:else class="mode-content">
        <!-- 步骤指示器标题 -->
        <view class="step-indicator-title">
          <text wx:if="{{currentStep === 1}}">选择祝福场景</text>
          <text wx:if="{{currentStep === 2}}">选择节日类型</text>
          <text wx:if="{{currentStep === 3}}">选择目标人群</text>
          <text wx:if="{{currentStep === 4}}">选择祝福风格</text>
        </view>

        <!-- 步骤指示器 -->
        <view class="step-indicator">
          <view class="step-item {{currentStep === 1 ? 'active' : ''}}">
            <view class="step-number">1</view>
          </view>
          <view class="step-separator"></view>
          <view class="step-item {{currentStep === 2 ? 'active' : ''}}">
            <view class="step-number">2</view>
          </view>
          <view class="step-separator"></view>
          <view class="step-item {{currentStep === 3 ? 'active' : ''}}">
            <view class="step-number">3</view>
          </view>
          <view class="step-separator"></view>
          <view class="step-item {{currentStep === 4 ? 'active' : ''}}">
            <view class="step-number">4</view>
          </view>
        </view>

        <!-- 步骤内容 -->
        <!-- 步骤1: 祝福场景 -->
        <view wx:if="{{currentStep === 1}}" class="step-content">
          <view class="input-group">
            <label class="input-label">请选择祝福场景 *</label>
            <picker
              mode="selector"
              range="{{scenarios}}"
              range-key="label"
              value="{{scenarioIndex}}"
              bindchange="onScenarioChange"
            >
              <view class="picker-input {{formData.scenario ? '' : 'placeholder'}}">
                {{formData.scenario ? scenarios[scenarioIndex].label : '请选择祝福场景'}}
              </view>
            </picker>
          </view>

          <view class="step-navigation">
            <button class="btn-step-next" bindtap="nextStep" disabled="{{!formData.scenario}}">下一步</button>
          </view>
        </view>

        <!-- 步骤2: 节日类型 -->
        <view wx:elif="{{currentStep === 2}}" class="step-content">
          <view class="input-group">
            <label class="input-label">请选择节日类型</label>
            <picker
              mode="selector"
              range="{{festivals}}"
              range-key="label"
              value="{{festivalIndex}}"
              bindchange="onFestivalChange"
            >
              <view class="picker-input {{formData.festival ? '' : 'placeholder'}}">
                {{formData.festival ? festivals[festivalIndex].label : '无特定节日'}}
              </view>
            </picker>
          </view>

          <view class="step-navigation">
            <button class="btn-step-prev" bindtap="prevStep">上一步</button>
            <button class="btn-step-next" bindtap="nextStep">下一步</button>
          </view>
        </view>

        <!-- 步骤3: 目标人群 -->
        <view wx:elif="{{currentStep === 3}}" class="step-content">
          <view class="input-group">
            <label class="input-label">请选择目标人群 *</label>
            <picker
              mode="selector"
              range="{{targetPersons}}"
              range-key="label"
              value="{{targetPersonIndex}}"
              bindchange="onTargetPersonChange"
            >
              <view class="picker-input {{formData.targetPerson ? '' : 'placeholder'}}">
                {{formData.targetPerson ? targetPersons[targetPersonIndex].label : '请选择目标人群'}}
              </view>
            </picker>
          </view>

          <view class="step-navigation">
            <button class="btn-step-prev" bindtap="prevStep">上一步</button>
            <button class="btn-step-next" bindtap="nextStep" disabled="{{!formData.targetPerson}}">下一步</button>
          </view>
        </view>

        <!-- 步骤4: 祝福风格 -->
        <view wx:elif="{{currentStep === 4}}" class="step-content">
          <view class="input-group">
            <label class="input-label">请选择祝福风格</label>
            <picker
              mode="selector"
              range="{{styles}}"
              range-key="label"
              value="{{styleIndex}}"
              bindchange="onStyleChange"
            >
              <view class="picker-input">
                {{formData.style ? styles[styleIndex].label : '温馨亲切'}}
              </view>
            </picker>
          </view>

          <view class="step-navigation">
            <button class="btn-step-prev" bindtap="prevStep">上一步</button>
          </view>
        </view>
      </view>

      <!-- 生成按钮 -->
      <view class="generate-button-container">
        <button
          class="btn-generate {{loading ? 'loading' : ''}}"
          form-type="submit"
          disabled="{{loading || (!formData.useSmartMode && (!formData.scenario || !formData.targetPerson)) || (formData.useSmartMode && (!formData.customDescription || !formData.customDescription.trim()))}}"
        >
          <view class="button-content">
            <block wx:if="{{loading}}">
              <view class="loading-spinner"></view>
              <text>{{formData.useSmartMode ? '🧠 AI思考中...' : '🎊 生成中，请稍候...'}}</text>
            </block>
            <block wx:else>
              <text>{{formData.useSmartMode ? '🧠 智能生成' : '✨ 快速生成'}}</text>
            </block>
          </view>
        </button>
      </view>
    </form>
  </view>

  <!-- 底部：结果展示区域 -->
  <view class="result-section">
    <view wx:if="{{error}}" class="error-container">
      <view class="error-message">
        ❌ {{error}}
      </view>
    </view>

    <view wx:elif="{{blessing}}" class="result-container card-secondary">
      <view class="result-header">
        <text class="result-title">🎉 生成的祝福语</text>
        <view class="result-actions">
          <button class="action-btn" bindtap="onVoicePlay">
            <text decode="{{true}}">🔊 播放</text>
          </button>
          <button class="action-btn" bindtap="onCopy">
            <text decode="{{true}}">📋 复制</text>
          </button>
          <button class="action-btn" bindtap="onRegenerate">
            <text decode="{{true}}">🔄 重新生成</text>
          </button>
        </view>
      </view>

      <view class="blessing-content" bindlongpress="onLongPressCard">
        {{blessing}}
      </view>

      <!-- 复制成功提示 -->
      <view wx:if="{{copySuccess}}" class="copy-success {{copyFading ? 'fade-out' : ''}}">
        ✅ 已复制到剪贴板！
      </view>
    </view>

    <!-- 长按菜单 -->
    <view wx:if="{{showLongPressMenu}}" class="long-press-overlay" bindtap="hideLongPressMenu">
      <view class="long-press-menu" catchtap="">
        <view class="menu-item" bindtap="onCopy">
          <text>📋 复制祝福语</text>
        </view>
        <view class="menu-item" bindtap="onSaveImage">
          <text>💾 保存为图片</text>
        </view>
      </view>
    </view>

    <!-- 信封飞出动画 -->
    <view wx:if="{{showEnvelope}}" class="envelope-fly">
      <text>✉️</text>
    </view>
  </view>
</view>